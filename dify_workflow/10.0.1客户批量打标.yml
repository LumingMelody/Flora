app:
  description: æ ¹æ®è¯„ä»·è§„åˆ™ç»™å®¢æˆ·æ‰“æ ‡ç­¾ï¼Œæ”¯æŒå•ä¸ªæˆ–æ‰¹é‡å®¢æˆ·
  icon: ğŸ·ï¸
  icon_background: '#D5F5F6'
  mode: workflow
  name: 10.0.1å®¢æˆ·æ‰¹é‡æ‰“æ ‡
  use_icon_as_answer_icon: false
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: langgenius/tongyi:0.1.3@08f25a10c0617a3512fac091a0f0d894925357e965efe40fdf95cb48e09b62d1
    version: null
kind: app
version: 0.4.0
workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      allowed_file_extensions:
      - .JPG
      - .JPEG
      - .PNG
      - .GIF
      - .WEBP
      - .SVG
      allowed_file_types:
      - image
      allowed_file_upload_methods:
      - local_file
      - remote_url
      enabled: false
      fileUploadConfig:
        audio_file_size_limit: 50
        batch_count_limit: 5
        file_size_limit: 15
        image_file_size_limit: 10
        video_file_size_limit: 100
        workflow_file_upload_limit: 10
      image:
        enabled: false
        number_limits: 3
        transfer_methods:
        - local_file
        - remote_url
      number_limits: 3
    opening_statement: ''
    retriever_resource:
      enabled: false
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
      language: ''
      voice: ''
  graph:
    edges:
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: start
        targetType: http-request
      id: start-source-http_get_rule-target
      source: start
      sourceHandle: source
      target: http_get_rule
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: http-request
        targetType: code
      id: http_get_rule-source-code_parse_rule-target
      source: http_get_rule
      sourceHandle: source
      target: code_parse_rule
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: llm
      id: code_parse_rule-source-llm_evaluate-target
      source: code_parse_rule
      sourceHandle: source
      target: llm_evaluate
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: llm_evaluate-source-code_prepare_tags-target
      source: llm_evaluate
      sourceHandle: source
      target: code_prepare_tags
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: http-request
      id: code_prepare_tags-source-http_mark_tags-target
      source: code_prepare_tags
      sourceHandle: source
      target: http_mark_tags
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: http-request
        targetType: end
      id: http_mark_tags-source-end-target
      source: http_mark_tags
      sourceHandle: source
      target: end
      targetHandle: target
      type: custom
      zIndex: 0
    nodes:
    - data:
        desc: è¾“å…¥å®¢æˆ·ä¿¡æ¯å’Œè§„åˆ™ID
        selected: false
        title: å¼€å§‹
        type: start
        variables:
        - label: è§„åˆ™ID
          max_length: 48
          options: []
          required: true
          type: text-input
          variable: rule_id
        - label: å®¢æˆ·ä¿¡æ¯ï¼ˆJSONæ•°ç»„ï¼‰
          max_length: 10000
          options: []
          required: true
          type: paragraph
          variable: customers_json
        - label: ç”¨æˆ·id
          max_length: 48
          options: []
          required: true
          type: text-input
          variable: user_id
        - label: ç§Ÿæˆ·id
          max_length: 48
          options: []
          required: true
          type: text-input
          variable: tenant_id
      height: 220
      id: start
      position:
        x: 80
        y: 282
      positionAbsolute:
        x: 80
        y: 282
      selected: false
      type: custom
      width: 242
    - data:
        authorization:
          config: null
          type: no-auth
        body:
          data: []
          type: none
        headers: |
          Authorization:Bearer {{#start.user_id#}}
          tenant-id:{{#start.tenant_id#}}
        method: get
        params: ''
        retry_config:
          max_retries: 3
          retry_enabled: true
          retry_interval: 100
        selected: false
        ssl_verify: true
        timeout:
          max_connect_timeout: 0
          max_read_timeout: 0
          max_write_timeout: 0
        title: è·å–è¯„ä»·è§„åˆ™
        type: http-request
        url: https://your-api-domain.com/admin-api/scrm/customer-evaluation-rule/get?id={{#start.rule_id#}}
        variables: []
      height: 170
      id: http_get_rule
      position:
        x: 400
        y: 282
      positionAbsolute:
        x: 400
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: |
          import json

          def main(rule_response: str, customers_json: str) -> dict:
              result = {
                  "rule_content": "",
                  "customers": [],
                  "customer_count": 0,
                  "is_batch": False
              }
              try:
                  # è§£æè§„åˆ™å“åº”
                  rule_data = json.loads(rule_response)
                  if "data" in rule_data:
                      rule_content = rule_data["data"].get("ruleContent", "{}")
                  else:
                      rule_content = rule_response
                  result["rule_content"] = rule_content if isinstance(rule_content, str) else json.dumps(rule_content, ensure_ascii=False)

                  # è§£æå®¢æˆ·ä¿¡æ¯
                  customers = json.loads(customers_json)
                  if isinstance(customers, dict):
                      # å•ä¸ªå®¢æˆ·ï¼Œè½¬ä¸ºæ•°ç»„
                      customers = [customers]
                  result["customers"] = json.dumps(customers, ensure_ascii=False)
                  result["customer_count"] = len(customers)
                  result["is_batch"] = len(customers) > 1
              except Exception as e:
                  result["rule_content"] = f"è§£æå¤±è´¥: {str(e)}"
              return result
        code_language: python3
        outputs:
          rule_content:
            children: null
            type: string
          customers:
            children: null
            type: string
          customer_count:
            children: null
            type: number
          is_batch:
            children: null
            type: boolean
        selected: false
        title: è§£æè§„åˆ™å’Œå®¢æˆ·
        type: code
        variables:
        - value_selector:
          - http_get_rule
          - body
          value_type: string
          variable: rule_response
        - value_selector:
          - start
          - customers_json
          value_type: string
          variable: customers_json
      height: 52
      id: code_parse_rule
      position:
        x: 720
        y: 282
      positionAbsolute:
        x: 720
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            temperature: 0.3
          mode: chat
          name: deepseek-v3
          provider: langgenius/tongyi/tongyi
        prompt_template:
        - id: evaluate-system
          role: system
          text: |
            ä½ æ˜¯ä¸€åä¸“ä¸šçš„å®¢æˆ·åˆ†æå¸ˆã€‚è¯·æ ¹æ®æä¾›çš„è¯„ä»·è§„åˆ™ï¼Œå¯¹å®¢æˆ·è¿›è¡Œè¯„ä¼°å¹¶ç¡®å®šåº”è¯¥æ‰“çš„æ ‡ç­¾ã€‚

            è¯„ä¼°æµç¨‹ï¼š
            1. è§£æè¯„ä»·è§„åˆ™ä¸­çš„å„ä¸ªç»´åº¦å’ŒæŒ‡æ ‡
            2. æ ¹æ®å®¢æˆ·æ•°æ®ï¼Œé€ä¸€è¯„ä¼°æ¯ä¸ªæŒ‡æ ‡
            3. æ ¹æ®è¯„åˆ†æ ‡å‡†ç¡®å®šæ¯ä¸ªå®¢æˆ·åº”è¯¥è·å¾—çš„æ ‡ç­¾
            4. è¾“å‡ºæ¯ä¸ªå®¢æˆ·çš„è¯„ä¼°ç»“æœå’Œæ¨èæ ‡ç­¾

            è¯·ä»¥JSONæ ¼å¼è¾“å‡ºï¼Œç»“æ„å¦‚ä¸‹ï¼š
            {
              "evaluations": [
                {
                  "customerId": å®¢æˆ·ID,
                  "scores": {
                    "ç»´åº¦å": å¾—åˆ†
                  },
                  "totalScore": æ€»åˆ†,
                  "recommendedTags": ["æ ‡ç­¾1", "æ ‡ç­¾2"],
                  "tagIds": [æ ‡ç­¾ID1, æ ‡ç­¾ID2],
                  "reason": "è¯„ä¼°ç†ç”±ç®€è¿°"
                }
              ]
            }

            æ³¨æ„ï¼š
            - tagIds åº”è¯¥æ˜¯æ•°å­—ç±»å‹çš„æ ‡ç­¾IDï¼Œéœ€è¦æ ¹æ®ç³»ç»Ÿä¸­å·²æœ‰çš„æ ‡ç­¾ä½“ç³»æ˜ å°„
            - å¦‚æœæ— æ³•ç¡®å®šæ ‡ç­¾IDï¼Œå¯ä»¥å…ˆè¾“å‡ºæ ‡ç­¾åç§°ï¼Œåç»­é€šè¿‡ä»£ç æ˜ å°„
        - id: evaluate-user
          role: user
          text: |
            ã€è¯„ä»·è§„åˆ™ã€‘
            {{#code_parse_rule.rule_content#}}

            ã€å¾…è¯„ä¼°å®¢æˆ·ä¿¡æ¯ã€‘
            {{#code_parse_rule.customers#}}

            è¯·æ ¹æ®è§„åˆ™è¯„ä¼°ä»¥ä¸Šå®¢æˆ·ï¼Œå¹¶ç»™å‡ºæ¨èæ ‡ç­¾ã€‚
        selected: false
        structured_output:
          schema:
            additionalProperties: false
            properties:
              evaluations:
                type: array
                items:
                  type: object
                  properties:
                    customerId:
                      type: number
                    scores:
                      type: object
                    totalScore:
                      type: number
                    recommendedTags:
                      type: array
                      items:
                        type: string
                    tagIds:
                      type: array
                      items:
                        type: number
                    reason:
                      type: string
                  required:
                  - customerId
                  - recommendedTags
                  - reason
            required:
            - evaluations
            type: object
        structured_output_enabled: true
        title: è¯„ä¼°å®¢æˆ·å¹¶æ¨èæ ‡ç­¾
        type: llm
        vision:
          enabled: false
      height: 88
      id: llm_evaluate
      position:
        x: 1040
        y: 282
      positionAbsolute:
        x: 1040
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: |
          import json

          def main(evaluations: dict, is_batch: bool) -> dict:
              result = {
                  "request_body": "",
                  "use_batch_api": False,
                  "customer_ids": [],
                  "tag_ids": []
              }
              try:
                  evals = evaluations.get("evaluations", [])
                  if not evals:
                      result["request_body"] = json.dumps({"error": "æ— è¯„ä¼°ç»“æœ"})
                      return result

                  # æ”¶é›†æ‰€æœ‰å®¢æˆ·IDå’Œæ ‡ç­¾ID
                  all_customer_ids = []
                  all_tag_ids = set()

                  for ev in evals:
                      cid = ev.get("customerId")
                      if cid:
                          all_customer_ids.append(cid)
                      tags = ev.get("tagIds", [])
                      for t in tags:
                          if isinstance(t, int) and t > 0:
                              all_tag_ids.add(t)

                  result["customer_ids"] = all_customer_ids
                  result["tag_ids"] = list(all_tag_ids)

                  # åˆ¤æ–­ä½¿ç”¨å•ä¸ªè¿˜æ˜¯æ‰¹é‡API
                  if len(all_customer_ids) == 1:
                      # å•ä¸ªå®¢æˆ·ï¼šä½¿ç”¨ mark-tags API
                      result["use_batch_api"] = False
                      result["request_body"] = json.dumps({
                          "customerId": all_customer_ids[0],
                          "addTagIds": list(all_tag_ids)
                      }, ensure_ascii=False)
                  else:
                      # å¤šä¸ªå®¢æˆ·ï¼šä½¿ç”¨ mark-tags-batch API
                      result["use_batch_api"] = True
                      result["request_body"] = json.dumps({
                          "customerIds": all_customer_ids,
                          "tagIds": list(all_tag_ids)
                      }, ensure_ascii=False)

              except Exception as e:
                  result["request_body"] = json.dumps({"error": str(e)})
              return result
        code_language: python3
        outputs:
          request_body:
            children: null
            type: string
          use_batch_api:
            children: null
            type: boolean
          customer_ids:
            children: null
            type: array[number]
          tag_ids:
            children: null
            type: array[number]
        selected: false
        title: å‡†å¤‡æ‰“æ ‡è¯·æ±‚
        type: code
        variables:
        - value_selector:
          - llm_evaluate
          - structured_output
          value_type: object
          variable: evaluations
        - value_selector:
          - code_parse_rule
          - is_batch
          value_type: boolean
          variable: is_batch
      height: 52
      id: code_prepare_tags
      position:
        x: 1360
        y: 282
      positionAbsolute:
        x: 1360
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        authorization:
          config: null
          type: no-auth
        body:
          data:
          - id: key-value-tags
            key: ''
            type: text
            value: "{{#code_prepare_tags.request_body#}}"
          type: json
        headers: |
          Authorization:Bearer {{#start.user_id#}}
          tenant-id:{{#start.tenant_id#}}
          Content-Type:application/json
        method: post
        params: ''
        retry_config:
          max_retries: 3
          retry_enabled: true
          retry_interval: 100
        selected: false
        ssl_verify: true
        timeout:
          max_connect_timeout: 0
          max_read_timeout: 0
          max_write_timeout: 0
        title: è°ƒç”¨æ‰“æ ‡API
        type: http-request
        url: https://your-api-domain.com/admin-api/scrm/customer-info/mark-tags-batch
        variables: []
      height: 170
      id: http_mark_tags
      position:
        x: 1680
        y: 282
      positionAbsolute:
        x: 1680
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        desc: è¾“å‡ºæ‰“æ ‡ç»“æœ
        outputs:
        - value_selector:
          - http_mark_tags
          - body
          value_type: string
          variable: mark_result
        - value_selector:
          - llm_evaluate
          - structured_output
          value_type: object
          variable: evaluations
        - value_selector:
          - code_prepare_tags
          - customer_ids
          value_type: array[number]
          variable: customer_ids
        - value_selector:
          - code_prepare_tags
          - tag_ids
          value_type: array[number]
          variable: tag_ids
        selected: false
        title: ç»“æŸ
        type: end
      height: 180
      id: end
      position:
        x: 2000
        y: 282
      positionAbsolute:
        x: 2000
        y: 282
      selected: false
      type: custom
      width: 242
    viewport:
      x: 0
      y: 100
      zoom: 0.6
  rag_pipeline_variables: []
